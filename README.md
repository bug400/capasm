CAPASM: an Assembler for the HP Capricorn CPU
=============================================


Index
-----

* [Description](#description)
* [Features](#features)
* [Compatibility](#compatibility)
* [Installation](#installation)
* [Basic usage](#basic-usage)
* [Command line parameters](#command-line-parameters)
* [Create Lex files for the HP-75](#create-lex-files-for-the-hp-75)
* [License](#license)
* [Acknowledgements](#acknowledgements)

Description
-----------
CAPASM is a software suite primary intended for programmers who write LEX files
for the HP-75 handheld computer. The software includes an assembler (capasm)
which is almost compatible to the assembler which is part of the HP-83/85
Assembler ROM. The MAKELEX75 utility converts the binary object file, which
is generated by the assembler into a HP-75 lex file.

CAPASM is entirely written in Python3.

Features
--------

The assembler is compatible to the HP-83/85 ROM Assembler with the following
exceptions:

* The GLO, LNK and all conditional pseudo ops are not supported and throw
  an error
* The ABS 16 and ABS 32 pseudo ops are not supported. To compile ROM code
  use ABS nnnn, where nnnn is an octal number of the base address.
* ASC and ASP only support quoted strings as arguments. A quote within a
  string must be expressed as a double quote, e.g. ""","" MISSING".
* The pseudo ops LST and UNL are silently ignored.
* The assembler provides built in symbol tables for the HP-85, HP-87 and
  HP-75. The "-m" option specifies which table to use. This makes an
  ORG pseudo op redundant. The global symbol table for the HP-85 is the default.
* The assembler provides a symbol cross reference listing which is activated
  with the "-r 2" option.
* Line numbers in the assembler source file are optional

You can get the manual for the HP-83/85 ROM Assembler from the 
[www.series80.org](http://www.series80.org) web site.

CAPDIS is a two pass assembler which resolves all symbols in the second pass.
The HP-83/85 ROM Assembler is a single pass assembler which backpatches the
generated object file as soon as a symbol is resolved. 

This may result in a different behavior if global symbols are redefined by 
local symbols.  Unless you are programming ROM code it is highly recommended 
to use the "-c" option to treat each redefinition of global symbols as an error.

Compatibility
-------------

CAPASM should run under LINUX, Windows 10 and mac OS, if a Python Interpreter (version 3.6 and higher) is available.


Installation
------------

See the [Installation Instructions](https://github.com/bug400/capasm/blob/master/INSTALL.md) for details.


Basic usage
-----------

The "hp85" subdirectory of this repository contains the sample HP-85 Lex file ftoc.asm from the HP-83/85 Assembler ROM manual. To assemble this file type:

        capasm ftoc.asm

This assembles the file and creates a binary object file "ftoc.bin". Any error messages are printed to the terminal.

To get a list file type:

        capasm ftoc.asm -l ftoc.lst

This creates a list file with the default symbol table. To get a symbol table
with a cross reference use the "-r" option:

        capasm ftoc.asm -l ftoc.lst -r 2

If not specified, the name of the binar object file is the name of the source file with the extension ".bin". You can an other binary object file name with the "-b" option:

        capasm ftoc.asm -l ftoc.lst -b result.bin -r 2


Command line parameters
-----------------------

You get a description of the command line parameters if you type:

        capasm ftoc.asm -h

```
Usage: capasm [-h] [-b BINFILE] [-l LISTFILE] [-r {0,1,2}] [-p PAGESIZE]
              [-w WIDTH] [-m {75,85,87}] [-c] [-s {6,7,8,9,10}]
              sourcefile

positional arguments:
  sourcefile            source code file

optional arguments:
  -h, --help            show this help message and exit
  -b BINFILE, --binfile BINFILE
                        binary object code file
  -l LISTFILE, --listfile LISTFILE
                        list file
  -r {0,1,2}, --reference {0,1,2}
                        symbol reference 0:none, 1:short, 2:full
  -p PAGESIZE, --pagesize PAGESIZE
                        lines per page
  -w WIDTH, --width WIDTH
                        page width
  -m {75,85,87}, --machine {75,85,87}
                        Machine type
  -c, --check           activate additional checks
  -s {6,7,8,9,10}, --labelsize {6,7,8,9,10}

```

CAPASM provides built in repositories of the global symbols for the HP-83/85, HP86/87 or HP-75 computers. The repository is selected with the "-m" parameter.

If additional checks are enabled with the "-c" option then it is invalid to
invalid:

* redefine global symbols as local labels or constants
* use R# as data register operand in literal immediate mode, if the value of
  the drp is unknown, e.g.: `LABELA   ADM R#,1,2,3,4`



Create Lex files for the HP-75
------------------------------

The "lex75" subdirectory of this repository contains the sample assembler 
source file "phyconst.asm". To create a lex file for the HP-75 type:

        capasm phyconst.asm -m 75

This assembles the source file and creates a binary object file "phyconst.bin".
If you invoke the assembler with:

       capasm phyconst.asm -m 75 -l phyconst.lst -r 2

you get a full listing with symbol cross reference in the file "pyhconst.lst".
Do not forget to specify the "-m 75" option if you assemble files for the
HP-75.

To create a lex file for the HP-75 type:

      mkelx75 phyconst.bin

this creates a lex file phyconst.lex with a proper LIF header.

For a full description of the command line parameters invoke the programs with
the "-h" option.
  

License
-------

CAPASM is published under the GNU General Public License v2.0 License 
(see LICENSE file).


Acknowledgements
----------------

A special acknowledgement goes to 
[Everett Kaser](https://www.kaser.com/hp85.html).
He formerly wrote the HP-83/85 Assembler ROM software which is a heroic deed
compared to writing an assembler in Python without any constraints concerning
memory or CPU speed.

On his website you can download his HP85/HP87 emulator and a powerful disassembler (CAPDIS) for the Capricorn CPU. His  documentation 
[Understanding how the HP85 Works from the Inside](https://groups.io/g/hpseries80/wiki/1884)
and the assembler source files he disassembled from the ROM binaries 
were essential for me to get this software done.
